<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Final Decision</title>
    <style>
        .professor-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        .success-message {
            color: green;
            display: none;
            margin: 10px 0;
            padding: 10px;
            background-color: #dff0d8;
            border: 1px solid #d6e9c6;
            border-radius: 4px;
        }
        .error-message {
            color: red;
            display: none;
            margin: 10px 0;
            padding: 10px;
            background-color: #f2dede;
            border: 1px solid #ebccd1;
            border-radius: 4px;
        }
        .comment-N { color: #dc3545; }
        .comment-R { color: #ffc107; }
        .comment-YN { color: #17a2b8; }
        .comment-YF { color: #28a745; }
        button {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .legend {
            margin: 20px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .legend-item {
            margin: 5px 0;
            display: inline-block;
            margin-right: 20px;
        }
        /* Add debug outline for empty cells */
        td:empty {
            background-color: #fff3f3;
        }
    </style>
</head>
<body>
<h1>Final Decision</h1>

<div class="legend">
    <div class="legend-item">
        <span class="comment-N">●</span> N: Don't recommend for admission
    </div>
    <div class="legend-item">
        <span class="comment-R">●</span> R: Recommend but not interested in supervision
    </div>
    <div class="legend-item">
        <span class="comment-YN">●</span> YN: Recommend but no funding
    </div>
    <div class="legend-item">
        <span class="comment-YF">●</span> YF: Recommend and yes to funding
    </div>
</div>

<div th:each="profEntry : ${profApplications}" class="professor-section">
    <h2 th:text="'Professor ID: ' + ${profEntry.key}"></h2>
    <div th:id="'successMessage-' + ${profEntry.key}" class="success-message"></div>
    <div th:id="'errorMessage-' + ${profEntry.key}" class="error-message"></div>

    <form th:id="'finalDecisionForm-' + ${profEntry.key}"
          class="final-decision-form"
          th:data-prof-id="${profEntry.key}"
          th:data-admin-id="${adminUID}"
          th:data-event-id="${eventUID}">
        <table>
            <tr>
                <th>Student ID</th>
                <th>Professor Comment</th>
                <th>Select</th>
            </tr>
            <tr th:each="app : ${profEntry.value}">
                <td th:text="${app.userUID}"></td>
                <td>
                    <th:block th:if="${app.profcomment != null and !#strings.isEmpty(app.profcomment)}">
                        <th:block th:each="comment : ${#strings.arraySplit(app.profcomment, ';')}">
                            <th:block th:with="parts=${#strings.arraySplit(comment, ',')}">
                                <th:block th:if="${#arrays.length(parts) == 2 and parts[0].trim() == profEntry.key.toString()}">
                    <span th:class="'comment-' + ${parts[1].trim()}">
                        <span th:switch="${parts[1].trim()}">
                            <span th:case="'0'" th:text="'Don\'t recommend for admission'"></span>
                            <span th:case="'1'" th:text="'Recommend but not interested in supervision'"></span>
                            <span th:case="'2'" th:text="'Recommend but no funding'"></span>
                            <span th:case="'3'" th:text="'Recommend and yes to funding'"></span>
                            <span th:case="*" th:text="'Unknown comment: ' + ${parts[1].trim()}"></span>
                        </span>
                    </span>
                                </th:block>
                            </th:block>
                        </th:block>
                    </th:block>
                    <span th:if="${app.profcomment == null or #strings.isEmpty(app.profcomment)}" style="color: #666;">
                        No comment provided
                    </span>
                </td>

                <td><input type="checkbox" name="selectedStudents" th:value="${app.userUID}"></td>
            </tr>
        </table>
        <button type="submit">Submit Final Decision</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('.final-decision-form');

        forms.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();

                const profUID = this.getAttribute('data-prof-id');
                const adminUID = this.getAttribute('data-admin-id');
                const eventUID = this.getAttribute('data-event-id');

                const selectedCheckboxes = this.querySelectorAll('input[name="selectedStudents"]:checked');
                const selectedStudents = Array.from(selectedCheckboxes).map(cb => cb.value);

                const successMessage = document.getElementById(`successMessage-${profUID}`);
                const errorMessage = document.getElementById(`errorMessage-${profUID}`);

                fetch(`/admin/${adminUID}/adminEvent/${eventUID}/profprofile/${profUID}/finalDecision`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content')
                    },
                    body: selectedStudents.length > 0 ?
                        `selectedStudents[]=${selectedStudents.join('&selectedStudents[]=')}`
                        : 'selectedStudents[]='
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(result => {
                        successMessage.textContent = `Final decisions saved successfully for professor ${profUID}`;
                        successMessage.style.display = 'block';
                        errorMessage.style.display = 'none';
                        console.log('Success:', result);
                    })
                    .catch(error => {
                        errorMessage.textContent = 'Error saving final decisions: ' + error;
                        errorMessage.style.display = 'block';
                        successMessage.style.display = 'none';
                        console.error('Error:', error);
                    });
            });
        });
    });
</script>
</body>
</html>
